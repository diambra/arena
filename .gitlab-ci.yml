docker-build:
  image: docker:latest
  stage: build
  services:
    - docker:dind
  before_script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - apk add --no-cache make git
  only:
    - main
    - tags
    - web
  script:
    - |
      TAG=""
      [[ -n "$CI_COMMIT_TAG" ]] && TAG="$CI_COMMIT_TAG"
      [[ "$CI_COMMIT_BRANCH" == main ]] && TAG="main"
      if [[ -z "$TAG" ]]; then
        echo "Neither on tag nor main branch, build only"
        make images
        exit 0
      fi
    - VERSION=$TAG make push-images
